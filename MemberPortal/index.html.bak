<!DOCTYPE html>
<html>

<head>
  <base target="_top">
  <style>
    body {
      font-family: Arial, sans-serif;
      padding: 20px;
      max-width: 500px;
      margin: auto;
    }

    .hidden {
      display: none;
    }

    .error {
      color: red;
    }

    .dashboard {
      background: #f9f9f9;
      padding: 20px;
      border-radius: 8px;
      margin-top: 20px;
    }

    input[type="email"] {
      width: 100%;
      padding: 8px;
      margin: 6px 0 12px 0;
      border: 1px solid #ccc;
      border-radius: 4px;
    }

    button {
      padding: 10px 16px;
      border: none;
      background: #3367d6;
      color: #fff;
      border-radius: 4px;
      cursor: pointer;
    }

    button:hover {
      background: #254a9e;
    }
  </style>
</head>

<body>
  <div id="app"></div>

  <script>
    // Main application logic for the member portal dashboard

    function buildPrefilledFormUrl(section, member) {
      const url = new URL(section.url);
      const entryMap = section.entryMap;
      if (entryMap.emailAddress) url.searchParams.set(entryMap.emailAddress, member.emailAddress);
      if (entryMap.firstName) url.searchParams.set(entryMap.firstName, member.firstName);
      if (entryMap.lastName) url.searchParams.set(entryMap.lastName, member.lastName);
      if (entryMap.name) url.searchParams.set(entryMap.name, `${member.firstName} ${member.lastName}`);
      return url.toString();
    }

    let currentEmail = '';

/**
 * Generate the document 
 */
    function getDashboardContent(member, config) {
      console.log(`Generating content with ${member} + ${config}`);
      let content = '<div class="dashboard">';

      if (member.firstName && member.lastName) {
        content += `<h2>Welcome, ${member.firstName} ${member.lastName}</h2>`;
      }

      switch (member.login.status) {
        case 'UNVERIFIED':
          content += `<h2>Member Login</h2>
            <label for="email">Email Address:</label>
            <input type="email" id="email" required />
            <div id="step1">
              <button onclick="requestToken()">Login</button>
            </div>
            <p id="error" class="error">${member.error || ''}</p>`;
          break;

case 'TOKEN_EXPIRED':
case 'VERIFYING':
  content += `<p>A verification code has been sent to:</p>
    <input type="email" id="email" value="${member.emailAddress}" />
    <p><label for="token">Enter the code:</label></p>
    <input type="text" id="token" maxlength="6" />
    <p>
      <button onclick="verifyCode()">Verify</button>
      <button onclick="resendToken()">Resend Code</button>
    </p>
    <p id="error" class="error">${member.error || ''}</p>`;

          
          break;

        case 'VERIFIED':
          if (member.registration.status === 'NEW') {
            const registrationUrl = buildPrefilledFormUrl(config.forms.registration, member);
            content += `<p>You're almost done! Please complete your registration below.</p>
              <p><a href="${registrationUrl}" target="_blank">Complete Registration Form</a></p>`;

          } else if (member.registration.status === 'REGISTERED') {
            content += '<p>Thanks for verifying your email!</p>';
            const level = parseInt(member.level || 0);

            if (level >= 1) {
              content += `<ul>
                <li><a href="https://sites.google.com/keoweekrafters.org/makekeowee/schedule-of-classes-and-events" target="_blank">View the Schedule of Classes and Events</a></li>`;
            }

            if (level >= 2) {
              if (config?.forms?.volunteer?.url && config?.forms?.volunteer?.entryMap) {
                const volunteerUrl = buildPrefilledFormUrl(config.forms.volunteer, member);
                content += `<li><a href="${volunteerUrl}" target="_blank">Volunteer Hours Form</a></li>`;
              }
              content += `<li><a href="https://forms.gle/YOUR_OTHER_FORM" target="_blank">Class Proposal Form</a></li>
                <li><a href="https://drive.google.com/drive/folders/YOUR_SHARED_FOLDER" target="_blank">Shared Member Documents</a></li>`;
            }

            if (level >= 10) {
              content += `<li><strong>Board Member Tools</strong></li>`;
            }

            if (level >= 20) {
              content += `<li><strong>Admin Dashboard</strong></li>`;
            }

            content += '</ul>';

          } else if (member.registration.status === 'APPLIED') {
            const waiverUrl = buildPrefilledFormUrl(config.forms.waiver, member);
            content += `<p>One last step! Please sign the required liability waiver to activate your membership.</p>
              <p><a href="${waiverUrl}" target="_blank">Sign Waiver Form</a></p>`;

          } else if (member.registration.status === 'PENDING') {
            content += `<p>Thank you for registering! Your membership is currently <strong>pending</strong> until payment and waiver are verified by an administrator.</p>`;

          } else {
            content += `<p>Your membership status is ${member.login.status.toLowerCase()}.</p>`;
          }

          content += `<button onclick="logout()">Logout</button>`;
          break;

        default:
          content += `<p>Unknown status.</p>`;
      }

      content += '</div>';
      return content;
    }

    function renderDashboard(user) {
      google.script.run.withSuccessHandler(config => {
        document.getElementById('app').innerHTML = getDashboardContent(user, config);
      }).getSharedConfig();
    }

    function requestToken() {
      const emailInput = document.getElementById('email');
      emailInput.blur();
      const email = emailInput.value.trim();
      currentEmail = email;

      if (!email) {
        renderDashboard({ login: { status:  'VERIFYING', error: 'Please enter a valid email address.' } });
        return;
      }

      if (!email.includes('@') || !email.includes('.')) {
        renderDashboard({ login: { status:  'VERIFYING', error: 'Please enter a valid email address.' } });
        return;
      }

      google.script.run
        .withFailureHandler(e => {
          renderDashboard({ login: { status:  'VERIFYING', error: e.message } });
        })
        .withSuccessHandler(res => {
          
          const response = JSON.parse(res); 
          if (response && response.success) {
            const member = response.data; 
            renderDashboard(member);
          } else {
            renderDashboard({ login: { status:  'VERIFYING', error: 'Email not found in member registry.' } });
          }
        })
        .login(email);
    }

    function verifyCode() {
      const token = document.getElementById('token').value.trim();
      google.script.run.withSuccessHandler(res => {
        
      const response = JSON.parse(res); 
        if (!response.success) {
          document.getElementById('error').textContent = res.message;
          return;
        }

        if (response.redirectToForm) {
          const map = response.entryMap;
          const url = response.formUrl + `?${map.email}=${encodeURIComponent(currentEmail)}`;
          window.location.href = url;
        } else {
          const member = response.data;
          renderDashboard(member);
        }
      }).verifyToken(currentEmail, token);
    }

function resendToken() {
  const emailInput = document.getElementById('email');
  const email = emailInput?.value?.trim();
  if (!email) return;

  currentEmail = email;

  const resendBtn = Array.from(document.querySelectorAll("button"))
    .find(btn => btn.textContent.includes("Resend"));
  if (resendBtn) {
    resendBtn.disabled = true;
    setTimeout(() => resendBtn.disabled = false, 30000);
  }

  google.script.run
    .withFailureHandler(e => {
      renderDashboard({ login: { status:  'VERIFYING', error: e.message } });
    })
    .withSuccessHandler(res => {
      const response = JSON.parse(res); 
      if (response && response.success) {
        const member  = response.data; 
        document.getElementById('error').textContent = `Verification code resent to ${member.emailAddress}`;
        renderDashboard(member);
      } else {
        renderDashboard({ login: { status:  'VERIFYING', error: 'Unable to resend code.' } });
      }
    })
    .login(email);
}
    
    function logout() {
      google.script.run.withSuccessHandler( () =>  renderDashboard({ login: { status:  'UNVERIFIED' } }))
      .logout(email);
    }

    renderDashboard({ login: { status:  'UNVERIFIED' } });
  </script>
</body>

<h5>Version: SNAPSHOT-0.01.041</h5>

</html>